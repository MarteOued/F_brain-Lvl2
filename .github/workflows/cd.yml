# Ce fichier dÃ©ploie automatiquement ton code quand tu push sur main
name: DÃ©ploiement Automatique

# QUAND Ã§a se dÃ©clenche : seulement sur main/master aprÃ¨s que les tests passent
on:
  push:
    branches: [ main, master ]

jobs:
  # JOB 1: Construire et sauvegarder les images Docker
  build-images:
    name: "ğŸ—ï¸ Construction des images Docker"
    runs-on: ubuntu-latest
    # Seulement si on est sur main/master
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: "ğŸ“¥ RÃ©cupÃ©ration du code"
      uses: actions/checkout@v4

    - name: "ğŸ³ Configuration Docker"
      uses: docker/setup-buildx-action@v3

    # Optionnel : Si tu veux push sur Docker Hub
    # DÃ©commente ces lignes si tu veux sauvegarder tes images
    # - name: "ğŸ” Connexion Docker Hub"
    #   uses: docker/login-action@v3
    #   with:
    #     username: ${{ secrets.DOCKER_USERNAME }}
    #     password: ${{ secrets.DOCKER_PASSWORD }}

    - name: "ğŸ—ï¸ Build de toutes les images"
      run: |
        # âœ… CORRECTION: Utiliser la nouvelle syntaxe Docker Compose
        docker compose build
        echo "âœ… Toutes les images sont construites !"
        
        # Optionnel : Les taguer pour Docker Hub
        # docker tag f_brain-lvl2_web:latest ${{ secrets.DOCKER_USERNAME }}/f-brain-web:latest
        # docker tag f_brain-lvl2_frontend:latest ${{ secrets.DOCKER_USERNAME }}/f-brain-frontend:latest
        
        # Optionnel : Les pusher sur Docker Hub  
        # docker push ${{ secrets.DOCKER_USERNAME }}/f-brain-web:latest
        # docker push ${{ secrets.DOCKER_USERNAME }}/f-brain-frontend:latest

  # JOB 2: Simulation de dÃ©ploiement (pour commencer)
  deploy-simulation:
    name: "ğŸš€ Simulation de dÃ©ploiement"
    runs-on: ubuntu-latest
    needs: build-images
    
    steps:
    - name: "ğŸ“¥ RÃ©cupÃ©ration du code"
      uses: actions/checkout@v4

    - name: "ğŸ§ª Test de dÃ©ploiement local"
      run: |
        echo "ğŸš€ Simulation du dÃ©ploiement..."
        
        # âœ… CORRECTION: Utiliser la nouvelle syntaxe Docker Compose
        docker compose up -d
        
        # Attendre que tout soit prÃªt
        echo "â³ Attente que les services dÃ©marrent..."
        sleep 45
        
        # VÃ©rifier que les services rÃ©pondent
        echo "ğŸ” VÃ©rification des services..."
        
        # Test du backend
        if curl -f http://localhost:8000/health 2>/dev/null; then
          echo "âœ… Backend fonctionne !"
        else
          echo "âš ï¸ Backend ne rÃ©pond pas (normal si pas de route /health)"
        fi
        
        # Test du frontend
        if curl -f http://localhost:5174 2>/dev/null; then
          echo "âœ… Frontend fonctionne !"
        else
          echo "âš ï¸ Frontend ne rÃ©pond pas"
        fi
        
        # Test du proxy nginx
        if curl -f http://localhost:80 2>/dev/null; then
          echo "âœ… Proxy nginx fonctionne !"
        else
          echo "âš ï¸ Proxy ne rÃ©pond pas"
        fi
        
        echo "ğŸ Simulation terminÃ©e !"
        
        # âœ… CORRECTION: Utiliser la nouvelle syntaxe Docker Compose
        docker compose down

  # JOB 3: Notification (optionnel)
  notify:
    name: "ğŸ“¢ Notification"
    runs-on: ubuntu-latest
    needs: [deploy-simulation]
    if: always()  # Toujours exÃ©cuter, mÃªme en cas d'Ã©chec
    
    steps:
    - name: "âœ… SuccÃ¨s du dÃ©ploiement"
      if: success()
      run: |
        echo "ğŸ‰ DÃ©ploiement rÃ©ussi !"
        echo "Ton application F-Brain a Ã©tÃ© dÃ©ployÃ©e avec succÃ¨s."
        
    - name: "âŒ Ã‰chec du dÃ©ploiement"  
      if: failure()
      run: |
        echo "ğŸ˜ Quelque chose a Ã©chouÃ©..."
        echo "VÃ©rifie les logs ci-dessus pour voir le problÃ¨me."

# POUR PLUS TARD : DÃ©ploiement rÃ©el sur un serveur
# Une fois que tu as un serveur, tu peux dÃ©commenter et adapter ceci :
#
#  deploy-real:
#    name: "ğŸš€ DÃ©ploiement rÃ©el"
#    runs-on: ubuntu-latest  
#    needs: build-images
#    # Seulement si tu as configurÃ© un serveur
#    if: false  # Changer Ã  true quand tu es prÃªt
#    
#    steps:
#    - name: "ğŸš€ DÃ©ploiement SSH"
#      uses: appleboy/ssh-action@v1.0.0
#      with:
#        host: ${{ secrets.SERVER_HOST }}
#        username: ${{ secrets.SERVER_USER }}
#        key: ${{ secrets.SERVER_SSH_KEY }}
#        script: |
#          cd /path/to/your/app
#          git pull origin main
#          # âœ… CORRECTION: Utiliser la nouvelle syntaxe Docker Compose
#          docker compose down
#          docker compose up -d